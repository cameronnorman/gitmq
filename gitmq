#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative './lib/gitmq'
require_relative './lib/storage'

config = GitMQ::Config.new(
  # logger instance
  logger: Logger.new(STDOUT),

  # set where to store data
  storage: GitMQ::Storage.new('/tmp/gitmq_storage'),

  # application identifier, used for tagging consumed messages
  id: 'consumer#1'
)

consumer = GitMQ::Consumer.new(config)
producer = GitMQ::Producer.new(config)

Thread.new do
  loop do
    producer.publish('master', "master message #{Time.now}")
    producer.publish('test', "test message #{Time.now}")
    sleep 1
  end
end

[
  Thread.new { consumer.consume('master') { |m| puts 'master: ' + m } },
  Thread.new { consumer.consume('test') { |m| puts 'test: ' + m } }
].map(&:join)
